<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados da Pesquisa - MovieVerse</title>
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/pesquisar.css">
</head>
<body>

  <!-- HEADER -->
  <header>
    <a class="logo" href="index.html">ðŸŽ¬ MovieVerse</a>
    <nav>
      <div class="user-menu">
        <a href="login.html" id="login-link">Login</a>
        <div id="user-dropdown" class="dropdown hidden">
          <button id="perfil-btn">Perfil</button>
          <button id="mylist-btn">Minha Lista</button>
          <button id="sobre-btn">Sobre NÃ³s</button>
          <button id="logout-btn">Terminar SessÃ£o</button>
        </div>
      </div>
    </nav>
  </header>

  <!-- BARRA DE PESQUISA -->
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Pesquisar filmes ou sÃ©ries...">
  </div>

  <main>
    <section>
      <h2>Resultados da Pesquisa</h2>
      <div id="resultados" class="media-row"></div>
    </section>
  </main>

  <footer>
    <p>Â© 2025 MovieVerse. Todos os direitos reservados.</p>
  </footer>

  <!-- SCRIPTS -->
  <!-- Fallbacks -->
  <script src="assets/data/filmes-fallback.js"></script>
  <script src="assets/data/series-fallback.js"></script>
  <!-- Utils -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/loginHeader.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      atualizarLogin();

      const resultados = document.getElementById("resultados");
      const searchInput = document.getElementById("search-input");
      const params = new URLSearchParams(window.location.search);
      const termo = params.get("q")?.toLowerCase() || "";

      async function buscarJSON() {
        resultados.innerHTML = "";

        const termoCache = sessionStorage.getItem("pesquisaTermo");
        const filmesCache = sessionStorage.getItem("pesquisaFilmes");
        const seriesCache = sessionStorage.getItem("pesquisaSeries");
        const filmesGuardados = filmesCache ? JSON.parse(filmesCache) : null;
        const seriesGuardadas = seriesCache ? JSON.parse(seriesCache) : null;

        let filmesFiltrados = [];
        let seriesFiltradas = [];

        if (
          termoCache === termo &&
          Array.isArray(filmesGuardados) &&
          Array.isArray(seriesGuardadas)
        ) {
          filmesFiltrados = filmesGuardados;
          seriesFiltradas = seriesGuardadas;
        } else {
          const filmesData = await fetchComFallback(
            "assets/data/filmes.json",
            window.FILMES_FALLBACK || { filmes: [] }
          );
          const seriesData = await fetchComFallback(
            "assets/data/series.json",
            window.SERIES_FALLBACK || { series: [] }
          );

          filmesFiltrados = (filmesData.filmes || []).filter(f =>
            f.title.toLowerCase().includes(termo)
          );
          seriesFiltradas = (seriesData.series || []).filter(s =>
            s.title.toLowerCase().includes(termo)
          );
        }

        const resultadosTotais = [
          ...filmesFiltrados.map(f => ({...f, type: "filme"})),
          ...seriesFiltradas.map(s => ({...s, type: "serie"}))
        ];

        if (resultadosTotais.length === 0) {
          resultados.innerHTML = "<p>Nenhum resultado encontrado.</p>";
          return;
        }

        resultadosTotais.forEach(item => {
          const div = document.createElement("div");
          div.classList.add("media-card");
          div.innerHTML = `
            <img src="${item.poster || 'assets/img/noimage.jpg'}" alt="${item.title}">
            <p>${item.title}</p>
          `;
          div.onclick = () => window.location.href = `detalhes.html?id=${item.id}&type=${item.type}`;
          resultados.appendChild(div);
        });
      }

      buscarJSON();

      // Pesquisa Enter
      searchInput.addEventListener("keypress", e => {
        if (e.key === "Enter") {
          const termo = e.target.value.trim();
          if (termo.length >= 2) {
            sessionStorage.removeItem("pesquisaTermo");
            sessionStorage.removeItem("pesquisaFilmes");
            sessionStorage.removeItem("pesquisaSeries");
            window.location.href = `pesquisar.html?q=${encodeURIComponent(termo)}`;
          }
        }
      });
    });
  </script>
</body>
</html>
