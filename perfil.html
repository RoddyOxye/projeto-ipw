<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perfil | MovieVerse</title>
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/perfil.css">
</head>
<body>
  <header>
    <a class="logo" href="index.html">üé¨ MovieVerse</a>
    <nav>
      <div class="user-menu">
        <a href="login.html" id="login-link">Login</a>
        <div id="user-dropdown" class="dropdown hidden">
          <button id="perfil-btn">Perfil</button>
          <button id="mylist-btn">Minha Lista</button>
          <button id="sobre-btn">Sobre N√≥s</button>
          <button id="logout-btn">Terminar Sess√£o</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="perfil-container">
    <div class="perfil-grid">
      <!-- Coluna esquerda: info e edi√ß√£o -->
      <div class="card">
        <h3>Minha Conta</h3>
        <p class="small">Informa√ß√µes da tua conta. Podes editar e guardar.</p>

        <div class="field">
          <label for="usernameInput">Nome de utilizador</label>
          <input id="usernameInput" type="text" placeholder="Nome de utilizador">
        </div>


        <div class="field">
          <label for="passwordInput">Palavra-passe</label>
          <input id="passwordInput" type="password" placeholder="Nova palavra-passe">
        </div>

        <div class="perfil-actions">
          <button id="saveProfileBtn" class="btn">Guardar</button>
          <button id="deleteAccountBtn" class="btn danger">Eliminar Conta</button>
        </div>

        <hr class="perfil-divider" />

        <div>
          <a class="mylist-link" href="minhaLista.html">Minha Lista</a>
        </div>
      </div>

      <!-- Coluna direita: reviews e atividade -->
      <div>
        <div class="card card-spaced">
          <h3>Resumo</h3>
          <p><strong>Nome:</strong> <span id="showUsername">‚Äî</span></p>
          <p><strong>Total reviews:</strong> <span id="showReviewCount">0</span></p>
        </div>

        <div class="card">
          <h3>As minhas reviews</h3>
          <div id="userReviews" class="reviews-list reviews-list-spaced">
            <!-- cards de reviews do utilizador -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 MovieVerse</p>
  </footer>

  <!-- scripts -->
  <!-- Fallbacks -->
  <script src="assets/data/filmes-fallback.js"></script>
  <script src="assets/data/series-fallback.js"></script>
  <!-- Utils -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/loginHeader.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  if (typeof atualizarLogin === "function") atualizarLogin();

  const usernameInput = document.getElementById("usernameInput");
  const passwordInput = document.getElementById("passwordInput");
  const saveBtn = document.getElementById("saveProfileBtn");
  const deleteBtn = document.getElementById("deleteAccountBtn");

  const showUsername = document.getElementById("showUsername");
  const showReviewCount = document.getElementById("showReviewCount");
  const userReviewsEl = document.getElementById("userReviews");

  const currentUserName = localStorage.getItem("currentUser");
  if (!currentUserName) {
    alert("Tens de iniciar sess√£o para ver o perfil.");
    window.location.href = "login.html";
    return;
  }

  async function carregarTodosUtilizadores() {
    let baseUsers = [];
    try {
      const res = await fetch("js/users.json");
      if (res.ok) baseUsers = await res.json();
    } catch (e) {}

    const localUsers = JSON.parse(localStorage.getItem("localUsers")) || [];
    const mapa = new Map();
    baseUsers.forEach(u => mapa.set(u.username, u));
    localUsers.forEach(u => mapa.set(u.username, u));
    return Array.from(mapa.values());
  }

  async function obterUtilizadorAtual() {
    const todos = await carregarTodosUtilizadores();
    return todos.find(u => u.username === currentUserName) || null;
  }

  async function preencherPerfil() {
    const user = await obterUtilizadorAtual();
    usernameInput.value = user?.username || currentUserName;
    showUsername.textContent = user?.username || currentUserName;
    renderUserReviewsFromStorage(currentUserName);
  }

  async function renderUserReviewsFromStorage(username) {
    const allReviews = JSON.parse(localStorage.getItem("reviews")) || [];
    const reviews = allReviews.filter(r => r.user === username);

    // Carrega JSONs de filmes e s√©ries
    const filmes = await fetch("assets/data/filmes.json").then(r => r.ok ? r.json() : { filmes: [] });
    const series = await fetch("assets/data/series.json").then(r => r.ok ? r.json() : { series: [] });

    reviews.forEach(r => {
      let itemData;
      if (r.type === "filme") itemData = filmes.filmes.find(f => f.id === r.id);
      if (r.type === "serie") itemData = series.series.find(s => s.id === r.id);
      r.title = itemData?.title || "T√≠tulo desconhecido";
      r.poster = itemData?.poster || "assets/img/noimage.jpg";
    });

    renderUserReviews(reviews);
  }

  function renderUserReviews(reviews) {
    userReviewsEl.innerHTML = "";
    showReviewCount.textContent = reviews.length;

    if (!reviews.length) {
      userReviewsEl.innerHTML = "<p class='small'>Ainda n√£o tens reviews.</p>";
      return;
    }

    reviews.forEach((r, idx) => {
      const div = document.createElement("div");
      div.className = "review-card";
      div.innerHTML = `
        <img class="review-poster" src="${r.poster}" alt="${r.title}">
        <div class="review-content">
          <strong>${r.title}</strong> - ${r.rating}‚òÖ
          <p class="review-comment">${r.comment}</p>
        </div>
      `;

      // Clique no coment√°rio abre detalhes
      div.querySelector(".review-content").addEventListener("click", () => {
        if (r.id && r.type) {
          window.location.href = `detalhes.html?id=${r.id}&type=${r.type}`;
        }
      });

      // Bot√£o de eliminar
      const delBtn = document.createElement("button");
      delBtn.className = "btn danger review-delete";
      delBtn.textContent = "Eliminar";

      delBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Evita abrir detalhes
        if (!confirm("Tens a certeza que queres eliminar este coment√°rio?")) return;

        let allReviews = JSON.parse(localStorage.getItem("reviews")) || [];
        allReviews = allReviews.filter(review => !(review.user === r.user && review.id === r.id && review.type === r.type && review.comment === r.comment));
        localStorage.setItem("reviews", JSON.stringify(allReviews));
        renderUserReviewsFromStorage(r.user);
      });

      div.appendChild(delBtn);
      userReviewsEl.appendChild(div);
    });
  }

  // Guardar edi√ß√£o de perfil
  saveBtn.addEventListener("click", async () => {
    const novoNome = usernameInput.value.trim();
    const novaPass = passwordInput.value.trim();

    if (!novoNome) return alert("O nome de utilizador n√£o pode estar vazio.");

    let localUsers = JSON.parse(localStorage.getItem("localUsers")) || [];
    let updated = false;

    for (let u of localUsers) {
      if (u.username === currentUserName) {
        u.username = novoNome;
        if (novaPass) u.password = novaPass;
        updated = true;
        break;
      }
    }

    if (!updated) {
      try {
        const base = await fetch("js/users.json").then(r => r.ok ? r.json() : []);
        const baseUser = (base || []).find(u => u.username === currentUserName);
        if (baseUser) {
          baseUser.username = novoNome;
          if (novaPass) baseUser.password = novaPass;
          localUsers.push(baseUser);
        } else {
          localUsers.push({ username: novoNome, password: novaPass });
        }
      } catch (e) {}
    }

    localStorage.setItem("localUsers", JSON.stringify(localUsers));
    localStorage.setItem("currentUser", novoNome);

    alert("Perfil atualizado!");
    window.location.reload();
  });

  // Eliminar conta
  deleteBtn.addEventListener("click", async () => {
    if (!confirm("Tens a certeza que queres eliminar a tua conta local? Esta a√ß√£o n√£o √© revers√≠vel.")) return;
    let localUsers = JSON.parse(localStorage.getItem("localUsers")) || [];
    localUsers = localUsers.filter(u => u.username !== currentUserName);
    localStorage.setItem("localUsers", JSON.stringify(localUsers));
    localStorage.removeItem("currentUser");
    localStorage.removeItem("loggedIn");
    alert("Conta eliminada. Ser√°s redirecionado para o in√≠cio.");
    window.location.href = "index.html";
  });

  preencherPerfil();
});
</script>
</body>
</html>
